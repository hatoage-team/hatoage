<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã¯ã¨ã‚ã’ãƒãƒ¼ã‚±ãƒƒãƒˆ - ãƒ¡ãƒ¼ãƒ«é€ä¿¡</title>

<meta name="description" content="ç¾å‘³ã—ã„ã¯ã¨ã‚ã’ã‚’å‡ºæ¥ãŸã¦ã§æä¾›ã™ã‚‹æ¶ç©ºã®ã‚³ãƒ³ãƒ“ãƒ‹å…¬å¼ã‚µã‚¤ãƒˆã®ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³ç™»éŒ²ã‚µã‚¤ãƒˆ">
<meta name="author" content="ã¯ã¨ã‚ã’ãƒãƒ¼ã‚±ãƒƒãƒˆ">

<link rel="canonical" href="https://hatoage.wata777.f5.si/">
<link rel="icon" href="/assets/logo.png">
<link rel="stylesheet" href="/style.css">

<!-- OGP -->
<meta property="og:title" content="ã¯ã¨ã‚ã’ãƒãƒ¼ã‚±ãƒƒãƒˆ">
<meta property="og:description" content="ã¯ã¨ã‚ã’å…¬å¼ãƒ¡ãƒ¼ãƒ«ãƒã‚¬ã‚¸ãƒ³ç™»éŒ²">
<meta property="og:type" content="website">
<meta property="og:image" content="https://hatoage.wata777.f5.si/assets/logo.png">
<meta name="twitter:card" content="summary_large_image">

<style>
body {
  font-family: sans-serif;
  background:#f6f6f6;
  padding:20px;
}
.box {
  background:#fff;
  padding:20px;
  border-radius:10px;
}
input, button {
  width:100%;
  padding:10px;
  margin-top:10px;
  font-size:16px;
}
button {
  background:#ff9800;
  border:none;
  color:#fff;
  border-radius:5px;
}
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.overlay .box {
  width:90%;
  max-width:320px;
}
/* ãã‚‹ãã‚‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #ff9800; /* ã¯ã¨ã‚ã’ã‚ªãƒ¬ãƒ³ã‚¸ */
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 10px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-box {
  text-align: center;
}
</style>
</head>

<body>

<%- include("partials/header") %>

<div class="box">
  <h2>ğŸ“® ã¯ã¨ã‚ã’ ãƒ¡ãƒ¼ãƒ«ç™»éŒ²</h2>
  <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
  <input id="emailInput" placeholder="example@gmail.com">
  <button onclick="sendOtp()">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
</div>

<div class="overlay" id="loadingOverlay">
  <div class="box loading-box">
    <div class="loader"></div>
    <p id="loadingText">é€ä¿¡ä¸­...</p>
  </div>
</div>

<!-- OTP -->
<div class="overlay" id="otpOverlay">
  <div class="box">
    <h3>èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›</h3>
    <input id="otpInput" placeholder="6æ¡ã‚³ãƒ¼ãƒ‰">
    <button onclick="verifyOtp()">ç¢ºèª</button>
  </div>
</div>

<!-- å®Œäº† -->
<div class="overlay" id="doneOverlay">
  <div class="box">
    <h3>âœ… ç™»éŒ²å®Œäº†</h3>
    <p>ãƒ¡ãƒ¼ãƒ«ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ</p>
  </div>
</div>

<a href="/" class="btn-link">ãƒ›ãƒ¼ãƒ </a>

<script>
async function sendOtp() {
  const email = document.getElementById("emailInput").value.trim();
  if (!email) {
    alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

document.getElementById("loadingOverlay").style.display = "flex";

try{
  const res = await fetch("/mail/send", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });

  if (!res.ok) {
    alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  document.getElementById("otpOverlay").style.display = "flex";
} catch (e) {
    alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
  } finally {
    // ãã‚‹ãã‚‹æ¶ˆã™
    document.getElementById("loadingOverlay").style.display = "none";
  }
}

async function verifyOtp() {
  const email = document.getElementById("emailInput").value.trim();
  const otp = document.getElementById("otpInput").value.trim();

  if (!otp) {
    alert("èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const res = await fetch("/mail/verify", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, otp })
  });

  const json = await res.json();

  if (json.ok) {
    document.getElementById("otpOverlay").style.display = "none";
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦å®Œäº†ç”»é¢ã®æ–‡è¨€ã‚’å¤‰ãˆã‚‹
    const doneOverlay = document.getElementById("doneOverlay");
    const title = doneOverlay.querySelector("h3");
    const message = doneOverlay.querySelector("p");

    if (json.status === "dup") {
      title.innerText = "â„¹ï¸ ç™»éŒ²æ¸ˆã¿";
      message.innerText = "ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚";
    } else {
      title.innerText = "âœ… ç™»éŒ²å®Œäº†";
      message.innerText = "ãƒ¡ãƒ¼ãƒ«ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼æ˜æ—¥ã‹ã‚‰ãŠå±Šã‘ã—ã¾ã™ğŸ•Š";
    }

    doneOverlay.style.display = "flex";
  } else {
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ãã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’è¡¨ç¤º
    alert(json.error || "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
  }
}
</script>

<%- include("partials/footer") %>

</body>
</html>
