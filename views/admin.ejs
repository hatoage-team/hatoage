<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>管理画面</title>
</head>
<body>

<h1>管理画面</h1>
<% if (error) { %>
  <p style="color: #d32f2f;"><%= error %></p>
<% } %>

<h2>商品追加</h2>
<form method="POST" action="/admin/products">
  <input name="slug" placeholder="slug" required>
  <input name="name" placeholder="商品名" required>
  <input name="amount" placeholder="量">
  <input name="price" type="number" placeholder="価格">
  <input name="image" placeholder="画像path(full)">
  <button type="submit">追加</button>
</form>


<hr>

<h2>ニュース追加</h2>
<form method="POST" action="/admin/news">
  <input name="uuid" placeholder="uuid(任意)">
  <input name="date" type="date" required>
  <input name="title" placeholder="ニュースタイトル" required>
  <input name="body" placeholder="本文" required>
  <button type="submit">追加</button>
</form>

<hr>

<h2>登録済み商品</h2>
<p id="status"><%= statusMessage || "" %></p>

<% product.forEach(p => { %>
  <div data-slug="<%= p.slug %>">
    <input class="name" value="<%= p.name %>">
    <input class="amount" value="<%= p.amount %>">
    <input class="price" type="number" value="<%= p.price %>">
    <input class="image" value="<%= p.image %>">

    <button onclick="update('<%= p.slug %>')">更新</button>
    <button onclick="remove('<%= p.slug %>')">削除</button>
  </div>
<% }) %>

<script>
function showStatus(message) {
  const status = document.getElementById("status");
  status.textContent = message;
}

async function update(slug) {
  const box = document.querySelector(`[data-slug="${slug}"]`);

  const body = {
    name: box.querySelector(".name").value,
    amount: box.querySelector(".amount").value,
    price: box.querySelector(".price").value,
    image: box.querySelector(".image").value
  };

  const response = await fetch(`/admin/products/${slug}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const result = await response.json();
  showStatus(response.ok ? "更新しました" : `更新に失敗しました: ${result.message || "unknown error"}`);
}

async function remove(slug) {
  if (!confirm("削除する？")) return;

  const response = await fetch(`/admin/products/${slug}`, { method: "DELETE" });
  const result = await response.json();

  if (!response.ok) {
    showStatus(`削除に失敗しました: ${result.message || "unknown error"}`);
    return;
  }

  showStatus("削除しました");
  location.reload();
}
</script>

</body>
</html>
